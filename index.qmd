---
title: "PF0953 - Tarea III"
author: "Alejandro Palacio Siebe"
format: html
toc: true
lang: es
theme: flatly
---

## 3.1 Carga de bibliotecas

```{r}
#| label: carga-bibliotecas
#| warning: false
#| message: false

library(tidyverse) # Coleccion de paquetes de Tidyverse
library(ggthemes) # Estilos para ggplot2
library(RColorBrewer) # Paletas de colores de RColorBrewer
library(viridisLite) # Paletas de colores de viridis
library(plotly) # Gr谩ficos interactivos
library(sf) # Manejo de datos vectoriales
library(terra) # Manejo de datos raster
library(raster) # Manejo de datos raster
library(leaflet) # Mapas interactivos
library(rgbif) # Acceso a datos en GBIF
library(geodata) # Datos geoespaciales
library(dismo) # Modelado de distribucion de especies
library(ggthemes)
library(hrbrthemes)
library(DT)
library(scales)
```

## 3.2 Obtenci贸n de datos de presencia

### 3.2.1 Definici贸n de especie

```{r}
#| label: obtencion-datos
#| warning: false
#| message: false

# Nombre de la especie
especie <- "Canis lupus baileyi"
```

### 3.2.2 Consulta a BGIF 

```{r}
#| label: obtencion-datos-2
#| warning: false
#| message: false

# Consulta a GBIF
respuesta <- occ_search(
  scientificName = especie, 
  hasCoordinate = TRUE,
  hasGeospatialIssue = FALSE,
  limit = 3000 # de observaciones a descargar. Revisar antes en GBIF cu谩ntas observaciones hay. 
)

# Extraer datos de presencia
presencia <- respuesta$data
```

### 3.2.3 Guardar datos en archivo .csv

```{r}
#| label: obtencion-datos-3
#| warning: false
#| message: false

# Guardar los datos de presencia en un archivo CSV
write_csv(presencia, 'presencia.csv')
```

### 3.2.4 Leer datos del archivo .csv

```{r}
#| label: obtencion-datos-4
#| warning: false
#| message: false

# Leer los datos de presencia de un archivo CSV
presencia <- read_csv('presencia.csv')
```

### 3.2.5 Convertir a objeto sf

```{r}
#| label: obtencion-datos-5
#| warning: false
#| message: false

presencia <- st_as_sf(
  presencia,
  coords = c("decimalLongitude", "decimalLatitude"),
  remove = FALSE, # conservar las columnas de las coordenadas
  crs = 4326
)
```

### 3.2.6 Gr谩fico de distribuci贸n por pa铆s

```{r}
#| label: gr谩fico-1
#| warning: false
#| message: false
#| code-fold: true

# Gr谩fico ggplot2
grafico_barras_ggplot2 <-
  presencia |>
  st_drop_geometry() |>
  ggplot(aes(x = fct_infreq(publishingCountry))) +
  geom_bar(
    aes(
      text = paste0(
        "Cantidad de registros de presencia: ", after_stat(count))),    
  fill = "#2CBAA9") +
  ggtitle("Cantidad de registros de presencia por pa铆s") +
  xlab("Pais") +
  ylab("Cantidad de registros de presencia") +
  labs(caption = "Fuente: GBIF") +
  theme_ipsum() +
  theme(plot.title = element_text(size = 14))

# Gr谩fico plotly
ggplotly(grafico_barras_ggplot2, tooltip = "text") |> 
  config(locale = 'es')
```

### 3.2.7 Gr谩fico de registros por pa铆s y estado

```{r}
#| label: grafico-2
#| warning: false
#| message: false
#| code-fold: true

# Gr谩fico de barras agrupadas por pa铆s y estado
grafico_barras2_ggplot2 <-
presencia |>
  ggplot(aes(x = publishingCountry, fill = stateProvince)) +
  geom_bar(position = "dodge") +
  ggtitle("Cantidad de Registros por Estado") +
  xlab("Pa铆s") +
  ylab("Cantidad de registros") +
  theme_ipsum() +
  theme(plot.title = element_text(size = 14)) +
  theme(legend.position = "none")

# Gr谩fico de barras plotly
ggplotly(grafico_barras2_ggplot2) |> 
  config(locale = 'es')
```

### 3.2.8 Mapa

```{r}
#| label: mapa-1
#| warning: false
#| message: false
#| code-fold: true

# Mapa
leaflet() |>
  addTiles(group = "Mapa general") |>
  addProviderTiles(
    providers$Esri.WorldImagery, 
    group = "Im谩genes satelitales"
  ) |>
  addProviderTiles(
    providers$CartoDB.Positron, 
    group = "Mapa blanco"
  ) |>  
  addCircleMarkers(
    # capa de registros de presencia (puntos)
    data = presencia,
    stroke = F,
    radius = 3,
    fillColor = '#2CBAA9',
    fillOpacity = 1,
    popup = paste(
      paste0("<strong>Pa铆s: </strong>", presencia$country),
      paste0("<strong>Localidad: </strong>", presencia$locality),
      paste0("<strong>Fecha: </strong>", presencia$eventDate),
      paste0("<strong>Fuente: </strong>", presencia$institutionCode),
      paste0("<a href='", presencia$occurrenceID, "'>M谩s informaci贸n</a>"),
      sep = '<br/>'
    ),
    group = "Registros de Canis lupus baileyi"
  ) |>
  addLayersControl(
    baseGroups = c("Mapa general", "Im谩genes satelitales", "Mapa blanco"),
    overlayGroups = c("Registros de Canis lupus baileyi"))
```



## 3.3 Obtendic贸n de variables ambientales

### 3.3.1 Consulta a WorldClim

#### 3.3.1.1 Obtenci贸n de variables bioclim谩ticas

```{r}
#| label: clima-1
#| warning: false
#| message: false

# Consulta a WorldClim
clima <- worldclim_global(var = 'bio', res = 10, path = tempdir())

# Nombres de las variables climaticas
names(clima)
```

#### 3.3.1.2 Obtenci贸n de modelo de elevaci贸n

```{r}
#| label: topografia-1
#| warning: false
#| message: false

# Obtener modelo de elevaci贸n (DEM) desde SRTM
dem <- elevation_global(res = 10, path = tempdir())

# Nombres de la variable topograf铆a
names(dem)
```


### 3.3.2 Definici贸n y aplicaci贸n a 谩rea de estudio

```{r}
#| label: clima-2
#| warning: false
#| message: false

# Definir la extensi贸n del 谩rea de estudio
area_estudio <- ext(
  min(presencia$decimalLongitude) - 20, 
  max(presencia$decimalLongitude) + 20,
  min(presencia$decimalLatitude) - 3, 
  max(presencia$decimalLatitude) + 8
)

# Recortar las variables bioclim谩ticas al 谩rea de estudio
clima <- crop(clima, area_estudio)

# Recortar modelo de elevaci贸n al 谩rea de estudio
dem <- crop(dem, area_estudio)
```

### 3.3.3 Generaci贸n de mapa

```{r}
#| label: mapa-2
#| warning: false
#| message: false
#| code-fold: true

# Paleta de colores de temperatura
colores_temperatura <- colorNumeric(
  palette = rev(brewer.pal(11, "RdYlBu")),
  values(clima$wc2.1_10m_bio_1),
  na.color = "transparent"
)

# Paleta de colores de precipitaci贸n
colores_precipitacion <- colorNumeric(
  palette = "Blues",
  values(clima$wc2.1_10m_bio_12),
  na.color = "transparent"
)

# Paleta de colores para topograf铆a
colores_topografia <- colorNumeric(
  palette = terrain.colors(10),
  values(dem),
  na.color = "transparent"
)

# Mapa
leaflet() |>
  addTiles(group = "Mapa general") |>
  addProviderTiles(
    providers$Esri.WorldImagery, 
    group = "Im谩genes satelitales"
  ) |>  
  addProviderTiles(
    providers$CartoDB.Positron, 
    group = "Mapa blanco"
  ) |>
  addRasterImage( # capa raster de temperatura
    clima$wc2.1_10m_bio_1,
    colors = colores_temperatura, # paleta de colores
    opacity = 0.6,
    group = "Temperatura"
  ) |>
  addRasterImage( # capa raster de precipitaci贸n
    clima$wc2.1_10m_bio_12,
    colors = colores_precipitacion, # paleta de colores
    opacity = 0.6,
    group = "Precipitaci贸n",
  ) |>
  addRasterImage( # Capa raster de topograf铆a
    dem,
    colors = colores_topografia,
    opacity = 0.6,
    group = "Topograf铆a"
  ) |>
  addCircleMarkers(
    # capa de registros de presencia (puntos)
    data = presencia,
    stroke = F,
    radius = 3,
    fillColor = '#2CBAA9',
    fillOpacity = 1,
    popup = paste(
      paste0("<strong>Pa铆s: </strong>", presencia$country),
      paste0("<strong>Localidad: </strong>", presencia$locality),
      paste0("<strong>Fecha: </strong>", presencia$eventDate),
      paste0("<strong>Fuente: </strong>", presencia$institutionCode),
      paste0("<a href='", presencia$occurrenceID, "'>M谩s informaci贸n</a>"),
      sep = '<br/>'
    ),
    group = "Registros de Canis lupus "
  ) |>  
  addLegend(
    title = "Temperatura",
    values = values(clima$wc2.1_10m_bio_1),
    pal = colores_temperatura,
    position = "bottomleft",
    group = "Temperatura"
  ) |>
  addLegend(
    title = "Precipitaci贸n",
    values = values(clima$wc2.1_10m_bio_12),
    pal = colores_precipitacion,
    position = "bottomleft",
    group = "Precipitaci贸n"
  ) |> 
  addLegend(
    title = "Topograf铆a",
    values = values(dem),
    pal = colores_topografia,
    position = "bottomleft",
    group = "Topograf铆a"
  ) |>
  addLayersControl(
    # control de capas
    baseGroups = c("Mapa general", "Im谩genes satelitales", "Mapa blanco"),
    overlayGroups = c("Temperatura", "Precipitaci贸n", "Topograf铆a", "Registros de Canis lupus baileyi")
  ) |>
  hideGroup("Precipitaci贸n") |>
  hideGroup("Temperatura")
```

## 3.4 Modelo de nicho ecol贸gico

### 3.4.1 Creaci贸n de  conjuntos de entrenamiento y evaluaci贸n

```{r}
#| label: modelo-1
#| warning: false
#| message: false

# Crear dataframe con columnas de longitud y latitud
coordenadas_presencia <- data.frame(
  decimalLongitude = presencia$decimalLongitude,
  decimalLatitude = presencia$decimalLatitude
)

# Eliminar coordenadas duplicadas
coordenadas_presencia <- unique(coordenadas_presencia)

# Establecer una "semilla" para garantizar que la selecci贸n aleatoria sea reproducible
set.seed(123)

# Cantidad de registros de presencia
n_presencia <- nrow(coordenadas_presencia)

# Con sample(), se selecciona aleatoriamente una proporci贸n (ej. 0.7) 
# de los 铆ndices de los datos de presencia para el conjunto de entrenamiento
indices_entrenamiento <- sample(
  1:n_presencia, 
  size = round(0.7 * n_presencia)
)

# Crear el subconjunto de entrenamiento utilizando los 铆ndices seleccionados
entrenamiento <- coordenadas_presencia[indices_entrenamiento, ]

# Crear el subconjunto de evaluaci贸n con los datos restantes
evaluacion <- coordenadas_presencia[-indices_entrenamiento, ]
```

### 3.4.2 Modelo Maxent

#### 3.4.2.1 Generaci贸n

```{r}
#| label: modelo-2
#| warning: false
#| message: false

# Los datos de clima deben convertirse al formato que usa el paquete raster
# debido a es este el que acepta el paquete dismo
clima <- raster::stack(clima)

# Ejecutar el modelo
modelo_maxent <- maxent(x = clima, p = entrenamiento)

# Aplicar el modelo entrenado a las variables clim谩ticas 
# para generar un mapa de idoneidad del h谩bitat
prediccion <- predict(modelo_maxent, clima)
```

#### 3.4.2.2 Evaluaci贸n

```{r}
#| label: modelo-3
#| warning: false
#| message: false

# terra::extract() extrae los valores del raster de predicci贸n 
# en las coordenadas de evaluaci贸n
# eval_pres almacena los valores de idoneidad predichos 
# en los puntos de evaluaci贸n de presencia
eval_pres <- terra::extract(
  prediccion, 
  evaluacion[, c('decimalLongitude', 'decimalLatitude')]
)

# Generar puntos aleatorios dentro del 谩rea de estudio definida. 
# Estos puntos se asumen como ausencias de la especie.
ausencias <- randomPoints(mask = clima, n = 1000)

# eval_aus almacena los valores de idoneidad predichos
# en los puntos de ausencia
eval_aus <- terra::extract(
  prediccion, 
  ausencias
)

# Generar estad铆sticas de evaluaci贸n del modelo
resultado_evaluacion <- evaluate(p = eval_pres, a = eval_aus)
```

### 3.4.3 Curva ROC y AUC

```{r}
#| label: modelo-4
#| warning: false
#| message: false
#| code-fold: true

# Datos para graficar la curva ROC
datos_roc <- data.frame(
  FPR = resultado_evaluacion@FPR,
  TPR = resultado_evaluacion@TPR,
  Umbral = resultado_evaluacion@t
)

# Valor AUC
auc <- resultado_evaluacion@auc

# Gr谩fico ggplot2
grafico_roc_ggplot2 <-
  ggplot(
    datos_roc, 
    aes(
      x = FPR, 
      y = TPR,
      u = Umbral
    )
  ) +
  geom_line(
    color = "#2CBAA9", 
    size = 1
  ) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "grey") +
  labs(title = paste("Curva ROC (AUC =", round(auc, 3), ")"),
       x = "Tasa de falsos positivos (FPR)",
       y = "Tasa de verdaderos positivos (TPR)") +
  theme_ipsum() +
  theme(plot.title = element_text(size = 14))


# Grfico plotly
ggplotly(grafico_roc_ggplot2) |> 
  config(locale = 'es')
```

### 3.4.4 Mapa de idoneidad del h谩bitat

```{r}
#| label: mapa-3
#| warning: false
#| message: false
#| code-fold: true

# Paleta de colores del modelo
colores_modelo <- colorNumeric(
  palette = c("white", "black"),
  values(prediccion),
  na.color = "transparent"
)

# Mapa
leaflet() |>
  addTiles(group = "Mapa general") |>
  addProviderTiles(
    providers$Esri.WorldImagery, 
    group = "Im谩genes satelitales"
  ) |>  
  addProviderTiles(
    providers$CartoDB.Positron, 
    group = "Mapa blanco"
  ) |>
  addRasterImage( # capa raster de temperatura
    clima$wc2.1_10m_bio_1,
    colors = colores_temperatura, # paleta de colores
    opacity = 0.6,
    group = "Temperatura",
  ) |>
  addRasterImage( # capa raster de precipitaci贸n
    clima$wc2.1_10m_bio_12,
    colors = colores_precipitacion, # paleta de colores
    opacity = 0.6,
    group = "Precipitaci贸n",
  ) |>
  addRasterImage( # capa raster del modelo de distribuci贸n
    prediccion,
    colors = colores_modelo,
    opacity = 0.6,
    group = "Modelo de distribuci贸n",
  ) |>  
  addCircleMarkers(
    # capa de registros de presencia (puntos)
    data = presencia,
    stroke = F,
    radius = 3,
    fillColor = '#2CBAA9',
    fillOpacity = 1,
    popup = paste(
      paste0("<strong>Pa铆s: </strong>", presencia$country),
      paste0("<strong>Localidad: </strong>", presencia$locality),
      paste0("<strong>Fecha: </strong>", presencia$eventDate),
      paste0("<strong>Fuente: </strong>", presencia$institutionCode),
      paste0("<a href='", presencia$occurrenceID, "'>M谩s informaci贸n</a>"),
      sep = '<br/>'
    ),
    group = "Registros de Canis lupus baileyi"
  ) |>  
  addLegend(
    title = "Temperatura",
    values = values(clima$wc2.1_10m_bio_1),
    pal = colores_temperatura,
    position = "bottomleft",
    group = "Temperatura"
  ) |>
  addLegend(
    title = "Precipitaci贸n",
    values = values(clima$wc2.1_10m_bio_12),
    pal = colores_precipitacion,
    position = "bottomleft",
    group = "Precipitaci贸n"
  ) |>
  addLegend(
    title = "Modelo de distribuci贸n",
    values = values(prediccion),
    pal = colores_modelo,
    position = "bottomright",
    group = "Modelo de distribuci贸n"
  ) |>  
  addLayersControl(
    # control de capas
    baseGroups = c("Mapa general", "Im谩genes satelitales", "Mapa blanco"),
    overlayGroups = c(
      "Temperatura",
      "Precipitaci贸n",
      "Modelo de distribuci贸n",
      "Registros de Canis lupus baileyi"
    )
  ) |>
  hideGroup("Temperatura") |>
  hideGroup("Precipitaci贸n")
```

### 3.4.5 Mapa binario de distribuci贸n

```{r}
#| label: mapa-4 
#| warning: false
#| message: false
#| code-fold: true

# Definir el umbral
umbral <- 0.5

# Crear el raster binario
prediccion_binaria <- (prediccion >= umbral) * 1

# Crear la paleta de colores para el raster binario
colores_prediccion_binaria <- colorFactor(
  palette = c("transparent", "#2CBAA9"),  # "transparent" para las 谩reas no adecuadas
  domain = c(0, 1),
  na.color = "transparent"
)

# Mapa
leaflet() |>
  addTiles(group = "Mapa general") |>
  addProviderTiles(
    providers$Esri.WorldImagery, 
    group = "Im谩genes satelitales"
  ) |>
  addProviderTiles(
    providers$CartoDB.Positron, 
    group = "Mapa blanco"
  ) |>
  addRasterImage(
    prediccion_binaria,
    colors = colores_prediccion_binaria,
    opacity = 0.6,
    group = "Modelo de distribuci贸n binario",
  ) |>
  addCircleMarkers(
    data = presencia,
    stroke = FALSE,
    radius = 3,
    fillColor = 'grey',
    fillOpacity = 1,
    popup = paste(
      paste0("<strong>Pa铆s: </strong>", presencia$country),
      paste0("<strong>Localidad: </strong>", presencia$locality),
      paste0("<strong>Fecha: </strong>", presencia$eventDate),
      paste0("<strong>Fuente: </strong>", presencia$institutionCode),
      paste0("<a href='", presencia$occurrenceID, "'>M谩s informaci贸n</a>"),
      sep = '<br/>'
    ),
    group = "Registros de Canis lupus baileyi"
  ) |>
  addLegend(
    title = "Modelo de distribuci贸n binario",
    labels = c("Ausencia", "Presencia"),
    colors = c("transparent", "#2CBAA9"),
    position = "bottomright",
    group = "Modelo de distribuci贸n binario"
  ) |>
  addLayersControl(
    baseGroups = c("Mapa general", "Im谩genes satelitales", "Mapa blanco"),
    overlayGroups = c(
      "Modelo de distribuci贸n binario",
      "Registros de Canis lupus baileyi"
    )
  )
```

### 3.4.6 Comentario

###### Para el modelo de nichos ecol贸gicos se utilizaron las variables ambientales de temperatura y precipitaci贸n, pues son variables fundamentales para determinar el clima y por ende el h谩bitat id贸neo de una especie. El modelo arroja un valor de AUC muy cercano a 1, por lo que indica una tasa alta de verdaderos posotivos e incluso una tasa baja de falsos negativos, por lo cual se puede considerar como un buen modelo de clasificaci贸n. 


